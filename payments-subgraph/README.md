# Payments Subgraph Graphweaver Project

This project is the Payments Subgraph.

## To Run

Create the following tables in a Postgres database called `invoice-payments`:

```sql
CREATE TABLE "payments" (
    "id" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "invoiceId" integer NOT NULL,
    "amount" numeric(10,2) NOT NULL,
    "reconciled" boolean NOT NULL DEFAULT false,
    "notes" text,
    "paymentMethod" character varying(20) NOT NULL,
    "agentId" integer
);

CREATE UNIQUE INDEX "payments_pkey" ON payments(id int4_ops);
CREATE INDEX "payments_invoiceId" ON payments("invoiceId" int4_ops);
CREATE INDEX "payments_agentId" ON payments("agentId" int4_ops);

CREATE TABLE "Trace" (
    "Id" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "SpanId" character varying(200) NOT NULL,
    "TraceId" character varying(200) NOT NULL,
    "ParentId" character varying(200),
    "Name" character varying(200) NOT NULL,
    "Timestamp" bigint NOT NULL,
    "Duration" bigint NOT NULL,
    "Attributes" jsonb
);

CREATE UNIQUE INDEX "PK_Track" ON "Trace"("Id" int4_ops);
CREATE INDEX "Trace_Timestamp" ON "Trace"("Timestamp" int8_ops);
CREATE INDEX "Trace_Name" ON "Trace"("Name" text_ops);
CREATE INDEX "Trace_ParentId" ON "Trace"("ParentId" text_ops);
```

Then install dependencies and run the project:

```console
$ pnpm i
$ pnpm start
```

## How it was made

We bootstrapped the project and ran introspection to get started:

```console
$ npx graphweaver@latest init
? What would your like to call your new project? payments-subgraph
? Which Graphweaver backends will you need? MikroORM - PostgreSQL Backend
? OK, we're ready- I'm going to create a new app in "/Users/kevin/development/federation-example/payments-subgraph" - is that OK? yes
All Done!
Make sure you cd to the new project directory, then run pnpm install and pnpm start.
$ cd payments-subgraph
$ pnpm i
$ npx graphweaver@latest import
Importing data source...
Source: postgresql

? What is the database name? invoice-payments
? What is the database server's hostname? 127.0.0.1
? What is the port? 5432
? What is the username to access the database server? postgres
? What is the password for this user?
⠙ Introspecting...Fetching database schema...
⠹ Introspecting...Building metadata...
Closing database connection...
Database connection closed.

Import Summary:
┌─────────┬───────────┬──────────────────────────────────────────┬─────────────────────────────┐
│ (index) │   name    │              entityFilePath              │       schemaFilePath        │
├─────────┼───────────┼──────────────────────────────────────────┼─────────────────────────────┤
│    0    │ 'Payment' │ 'backend/entities/postgresql/payment.ts' │ 'backend/schema/payment.ts' │
│    1    │  'Trace'  │  'backend/entities/postgresql/trace.ts'  │  'backend/schema/trace.ts'  │
└─────────┴───────────┴──────────────────────────────────────────┴─────────────────────────────┘

Imported 2 entities, creating the above files in your Graphweaver project.

? Overwrite this file backend/schema/index.ts? yes
? Overwrite this file backend/database.ts? yes
8 files have been successfully created in the project.
```

To enable federation we needed to pass a subgraph name to the Graphweaver Constructor in `backend/index.ts`.
In this example we've also enabled tracing by modifying the index file to look like this:

```typescript
import Graphweaver from "@exogee/graphweaver-server";
import { connection } from "./database";

import "./schema";

import { Trace } from "./entities";
import { MikroBackendProvider } from "@exogee/graphweaver-mikroorm";

export const traceProvider = new MikroBackendProvider(Trace, connection);

export const graphweaver = new Graphweaver({
  federationSubgraphName: "payments",
  openTelemetry: { traceProvider },
});

export const handler = graphweaver.handler();
```

So that the port doesn't conflict with the music subgraph while developing, we also modified the port that Graphweaver runs on in the `package.json` file by changing the `start` script to `graphweaver start --port 12345`.

That's it! Easy peesy.
